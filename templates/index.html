<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Fiches & Ressources - Solutions Transitions (scrap)</title>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 2rem; background:#f5f5f5; }
    h1, h2, h3 { font-weight: 600; }
    h1 { margin-bottom: 1.5rem; }
    section { margin-bottom: 3rem; }
    .doc-card { background:#fff; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 1rem; overflow: hidden; }
    .doc-header { display:flex; flex-direction:column; padding: 0.9rem 1.2rem; cursor:pointer; background:#f0f4fa; }
    .doc-header:hover { background:#e4edf9; }
    .doc-title { margin:0; font-size:1rem; }
    .doc-meta { font-size: 0.8rem; color:#666; margin-top:0.3rem; }
    .doc-meta a { color:#1a4b82; text-decoration:none; }
    .doc-body { padding: 0 1.2rem 1rem; display:none; }
    .doc-body.open { display:block; }
    .pdf-link { display:inline-block; margin:0.6rem 0 0.8rem; padding:0.3rem 0.7rem; border-radius:4px; background:#1a4b82; color:#fff; text-decoration:none; font-size:0.85rem; }
    .pdf-link:hover { background:#163a63; }
    p { line-height: 1.6; margin:0.25rem 0; }

    /* Zone de chat */
    #chat-container { margin: 1.5rem 0 3rem; padding: 1.5rem; background:#fff; border-radius:8px; border:1px solid #ddd; }
    #chat-log { max-height: 260px; overflow-y:auto; margin-bottom:1rem; font-size:0.9rem; }
    .chat-message-user { margin-bottom:0.5rem; }
    .chat-message-user strong { color:#1a4b82; }
    .chat-message-assistant { margin-bottom:0.9rem; }
    .assistant-content { margin-top:0.25rem; line-height:1.6; }
    .assistant-content h3 { margin:0.4rem 0 0.2rem; font-size:0.95rem; }
    .assistant-content p { margin:0.2rem 0; }
    .assistant-content ul, .assistant-content ol { margin:0.2rem 0 0.2rem 1.2rem; }
    #chat-input-row { display:flex; gap:0.5rem; }
    #chat-input { flex:1; padding:0.5rem; border-radius:4px; border:1px solid #ccc; font-family:inherit; }
    #chat-send { padding:0.5rem 0.9rem; border-radius:4px; border:none; background:#1a4b82; color:#fff; cursor:pointer; font-family:inherit; }
    #chat-send:hover { background:#163a63; }
    #chat-sources { margin-top:0.5rem; font-size:0.85rem; }
    #chat-sources a { color:#1a4b82; text-decoration:none; }
  </style>
</head>
<body>
  <h1>Solutions Transitions - Assistant & Ressources</h1>

  <section id="chat">
    <h2>Assistant IA</h2>
    <p style="font-size:0.9rem; color:#666; margin-bottom:1rem;">Posez vos questions sur la transition écologique des collectivités. L'assistant vous orientera vers les <strong></strong>fiches</strong> et ressources pertinentes du site Solutions Transitions.<br><em>L'assistant garde en mémoire vos 3 derniers échanges pour mieux vous répondre.</em></p>
    <div id="chat-container">
      <div id="chat-log"></div>
      <div id="chat-input-row">
        <input id="chat-input" type="text" placeholder="Posez votre question (ex : Comment financer la transition écologique ?)" />
        <button id="chat-send">Envoyer</button>
      </div>
      <div id="chat-sources"></div>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Chat IA
      const input = document.getElementById('chat-input');
      const sendBtn = document.getElementById('chat-send');
      const log = document.getElementById('chat-log');
      const sourcesDiv = document.getElementById('chat-sources');
      
      // Historique des messages pour la mémoire conversationnelle
      let conversationHistory = [];

      async function sendMessage() {
        const text = (input.value || '').trim();
        if (!text) return;

        // Affiche la question dans le log
        const userDiv = document.createElement('div');
        userDiv.className = 'chat-message-user';
        userDiv.innerHTML = '<strong>Vous :</strong> ' + text;
        log.appendChild(userDiv);
        log.scrollTop = log.scrollHeight;

        input.value = '';
        sourcesDiv.textContent = 'Recherche des informations pertinentes...';

        try {




          // Détecte si on est sur Netlify ou en local (Flask)
          const chatEndpoint = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? '/chat' 
            : '/.netlify/functions/chat';
          const resp = await fetch(chatEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text, history: conversationHistory })
          });

          const data = await resp.json();
          if (!resp.ok) {
            throw new Error(data.error || 'Erreur serveur');
          }

          const assistantDiv = document.createElement('div');
          assistantDiv.className = 'chat-message-assistant';

          const titleSpan = document.createElement('div');
          titleSpan.innerHTML = '<strong>Assistant :</strong>';
          assistantDiv.appendChild(titleSpan);

          const contentDiv = document.createElement('div');
          contentDiv.className = 'assistant-content';
          contentDiv.innerHTML = renderMarkdownToHtml(data.answer || '(pas de réponse)');
          assistantDiv.appendChild(contentDiv);

          log.appendChild(assistantDiv);
          log.scrollTop = log.scrollHeight;
          
          // Ajouter à l'historique pour la mémoire conversationnelle
          conversationHistory.push({ role: 'user', content: text });
          conversationHistory.push({ role: 'assistant', content: data.answer || '' });
          // Limiter l'historique aux 6 derniers messages (3 échanges)
          if (conversationHistory.length > 6) {
            conversationHistory = conversationHistory.slice(-6);
          }

          // Affiche les ressources proposées
          sourcesDiv.innerHTML = '';
          if (Array.isArray(data.sources) && data.sources.length) {
            const ul = document.createElement('ul');
            data.sources.forEach(function (s) {
              const li = document.createElement('li');
              const a = document.createElement('a');
              a.href = s.url;
              a.target = '_blank';
              a.rel = 'noopener';
              a.textContent = '[' + s.type + '] ' + s.title;
              li.appendChild(a);
              ul.appendChild(li);
            });
            const title = document.createElement('div');
            title.textContent = 'Informations suggérées :';
            sourcesDiv.appendChild(title);
            sourcesDiv.appendChild(ul);
          } else {
            sourcesDiv.textContent = 'Aucune information spécifique trouvée.';
          }
        } catch (err) {
          sourcesDiv.textContent = 'Erreur : ' + err;
        }
      }

      function renderMarkdownToHtml(text) {
        if (!text) return '';
        // Échapper les caractères HTML de base
        text = text
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');

        // Titres ###
        text = text.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');

        // Gras **...**
        text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        
        // Liens markdown [texte](url)
        text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
        
        // URLs entre parenthèses (URL) - format demandé par le prompt
        text = text.replace(/\((https?:\/\/[^\)]+)\)/g, '(<a href="$1" target="_blank" rel="noopener">lien</a>)');
        
        // URLs seules (pas déjà dans un lien)
        text = text.replace(/(?<!href="|>)(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');

        // Listes numérotées (1. ...)
        text = text.replace(/^(\d+)\.\s+(.*)$/gm, '<li>$2</li>');

        // Listes à puces (- ...)
        text = text.replace(/^\-\s+(.*)$/gm, '<li>$1</li>');

        // Regrouper les <li> consécutifs dans des <ul>
        text = text.replace(/(<li>[^<]*<\/li>\s*)+/g, function (match) {
          return '<ul>' + match + '</ul>';
        });

        // Paragraphes / sauts de ligne
        const lines = text.split(/\n+/);
        const htmlParts = lines.map(function (line) {
          if (!line.trim()) return '';
          if (line.startsWith('<h3>') || line.startsWith('<ul>') || line.startsWith('<ol>')) {
            return line;
          }
          if (line.startsWith('<li>')) {
            return '<ul>' + line + '</ul>';
          }
          return '<p>' + line + '</p>';
        }).filter(Boolean);

        return htmlParts.join('\n');
      }

      sendBtn.addEventListener('click', sendMessage);
      input.addEventListener('keydown', function (ev) {
        if (ev.key === 'Enter') {
          ev.preventDefault();
          sendMessage();
        }
      });
    });
  </script>
</body>
</html>
